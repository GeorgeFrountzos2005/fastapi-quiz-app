<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Quiz</title>
    <link rel="stylesheet" href="/static/style.css">

</head>
<body>
    <h2>Quiz Time!</h2>
    <div id="quizContainer"></div>
    <button id="submitQuiz" style="display:none;">Submit Quiz</button>
    <p id="quizResult"></p>
    <a href="/static/leaderboard.html">Leaderboard</a>
    <script>
    let questions = [];
    let userAnswers = [];

    async function loadQuestions() {
        const res = await fetch("/api/questions");
        const data = await res.json();
        questions = data.questions; // [{id, question, choices}]
        renderQuiz();
    }

    function renderQuiz() {
        const container = document.getElementById("quizContainer");
        container.innerHTML = "";
        questions.forEach((q, idx) => {
            let html = `<div><strong>Q${idx+1}:</strong> ${q.question}<br>`;
            q.choices.forEach((choice, cidx) => {
                html += `<label><input type="radio" name="q${idx}" value="${cidx}"> ${choice}</label> `;
            });
            html += "</div><br>";
            container.innerHTML += html;
        });
        document.getElementById("submitQuiz").style.display = "block";
    }

    document.getElementById("submitQuiz").onclick = async function() {
        // collect answers
        userAnswers = questions.map((q, idx) => {
            const selected = document.querySelector(`input[name="q${idx}"]:checked`);
            return { id: q.id, choice: selected ? parseInt(selected.value) : -1 };
        });

        const username = localStorage.getItem("username");
        if (!username) {
            document.getElementById("quizResult").innerText = "You must be logged in.";
            return;
        }

        // POST to /api/grade (server checks answers & saves best score)
        const res = await fetch("/api/grade", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ username, answers: userAnswers })
        });
        const result = await res.json();
        if (res.ok) {
            document.getElementById("quizResult").innerText =
                `Score: ${result.correct}/${result.total}` + (result.saved ? " (new high score saved!)" : "");
        } else {
            document.getElementById("quizResult").innerText = result.detail || "Error grading quiz.";
        }
    };

    loadQuestions();
    </script>


</body>
</html>
